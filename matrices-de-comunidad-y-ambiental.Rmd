---
title: "Apoyo para la preparación de datos de la PD02: matriz de comunidad y matriz ambiental<small><br>Biogeografía (GEO-131)<br>Universidad Autónoma de Santo Domingo (UASD)<br>Semestre 2024-02</small>"
author: "El Tali"
date: "`r format(Sys.Date(), '%Y-%m-%d')`"
output:
  # bookdown::github_document2:
  #   number_sections: false
  #   fig_caption: yes
  bookdown::html_document2:
    number_sections: false
    code_folding: show
    fig_caption: yes
    md_extensions: "-fancy_lists"
    toc: true
    toc_depth: 3
editor_options:
  chunk_output_type: console
bibliography: biblio.bib
csl: apa.csl
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  out.width = '100%',
  fig.retina = 4)
```

```{r, include=F}
output_format <- knitr::opts_knit$get("rmarkdown.pandoc.to")
repo_url <- system("git config --get remote.origin.url", intern = TRUE)
repo_name <- sub(".git$", "", basename(repo_url))
org_name <- basename(dirname(repo_url))
rmd_filename <- tools::file_path_sans_ext(basename(knitr::current_input()))
github_pages_url <- paste0("https://", org_name, ".github.io/", repo_name, "/", rmd_filename, ".html")
```

```{r, results='asis', echo=F}
if (grepl('gfm', output_format)) {
  cat('Versión HTML (quizá más legible), [aquí](', github_pages_url, ')\n', sep = '')
} else if (output_format == 'latex') {
  cat('Versión HTML (quizá más legible), [aquí](', github_pages_url, ')\n', sep = '')
}
```

# Generar las matrices de comunidad y ambiental

Creé funciones de ayuda para generar las matrices de comunidad y ambiental a partir de datos de GBIF [@gbiforg2022what] y el repositorio de estadística zonal sobre RD de @jose_ramon_martinez_batlle_2022_7367180, usando como índice espacial hexágonos de la biblioteca H3. Todas las funciones de ayuda las encapsulé en una tubería o toolchain denominado `generar_mc_ma`. Ejemplos de uso a continuación.

# Funciones

Primero cargo las funciones con el `source` del siguiente bloque de código.

```{r, warning=F, message=F}
source('matrices-de-comunidad-y-ambiental.R')
```

# Evaluación de la función para una familia, Acanthaceae

## Evaluar la función propiamente

A modo de ejemplo, a continuación genero las matrices de comunidad y ambiental de la familia Acanthaceae evaluando la función `generar_mc_ma`.

```{r, warning=F, message=F}
# Llamada a la función
acanthaceae <- generar_mc_ma(
  taxon = 'Acanthaceae',
  exportar_sf = T,
  exportar_mc = T,
  min_num_spp_hex = 2,
  min_num_hex_sp = 2)
```

Si la función se ejecutó correctamente, los directorios `salidas_RDS` y `salidas_sf` contienen archivos geográficos en formato `.RDS` y `.kml` (para abrir en QGIS o Google Earth) de los registros de presencia de GBIF, así como índice espacial de hexágonos H3. Los directorios `salidas_mc` y `salidas_ma` contienen archivos en formato `.RDS` de la matrices de comunidad y ambiental para cada taxon, respectivamente.

## Mapa

El objeto `acanthaceae` contiene todos los objetos creados por el *toolchain*. Uno de ellos consiste en un mapa de distribución de los registros de presencia de GBIF para el taxón, y los hexágonos de la biblioteca H3.

```{r}
# Mapa
acanthaceae$aoi_reg_hex_inter_g
```

La matriz de comunidad se puede imprimir con la función `kable` del paquete `kableExtra`.

```{r}
acanthaceae$mc %>% kableExtra::kable()
```

## Resumen de la matriz de comunidad y ambiental

Finalmente, un método de la función `summary` genera un resumen básico de los datos de comunidad.

```{r, results='asis', warning=F, message=F}
summary.mc_ma(acanthaceae, nombres_cortos = F, tamano_rotulo = 6)
```

# De forma masiva, 20 familias bien representada en GBIF para RD

## Selección de familias

```{r}
fam_sel <- c('Acanthaceae',
             'Bromeliaceae',
             'Cactaceae',
             'Fabaceae',
             'Myrtaceae',
             'Orchidaceae',
             'Asteraceae',
             'Poaceae',
             'Rubiaceae',
             'Melastomataceae',
             'Piperaceae',
             'Solanaceae',
             'Euphorbiaceae',
             'Tyrannidae',
             'Thraupidae',
             'Trochilidae',
             'Phyllostomidae',
             'Eleutherodactylidae',
             'Nymphalidae',
             'Orthoptera'
)
fam_sel <- sort(fam_sel)
```

## Evaluar la función propiamente (*be careful*)

El cometido de este bloque de abajo fue realizar una consulta "masiva" a la base de datos de GBIF y obtener registros de presencia para 20 familias de plantas y animales bien representadas en RD, los cuales son requeridos para realizar la práctica PD02 y se encuentran en los directorios `salidas_*`. Por lo tanto, no es necesario re-ejecutar este bloque, sólo se deja aquí para fines de reproducibilidad.

La consulta tomó varios minutos, y ocupó una buena porción de la RAM. Dado lo compleja de esta operación, la evaluación no se ejecutó con el tejido de este cuaderno (en el RMarkdown, el encabezado del código tiene `eval=F`), sino que se realizó de forma directa ejecutando el bloque de código.

El "*be careful*" en el título está dirigido a personas que tuviesen interés de ejecutar este bloque por cuenta propia (e.g. para otra selección de familias), en cuyo caso hay que tener cuidado de seleccionar apropiadamente un número razonablemente pequeño de familias.

```{r, eval=F, warning=F, message=F}
mc_ma_familias_seleccionadas_l <- sapply(fam_sel, function(x) {
  tryCatch(
    {
      generar_mc_ma(
        taxon = x,
        exportar_sf = TRUE,
        exportar_mc = TRUE
      )
    },
    error = function(e) {
      message(paste("Error en la familia:", x, ":", e$message))
      return(NULL)  # Retorna NULL en caso de error
    })
  }, simplify = FALSE)
saveRDS(
  object = mc_ma_familias_seleccionadas_l,
  file = 'salidas_RDS/todos_los_objetos_todas_las_familias.RDS') # Añadido al .gitignore
```

Al realizar la operación masiva anterior, se producen los mismos archivos que produje para el caso de la familia Acanthaceae, a saber: `salidas_RDS`, `salidas_sf`, `salidas_mc` y `salidas_ma`. Los archivos `.kml`, que se guardan en el directorio `salidas_sf` no se incluyeron en esta operación masiva `.kml`, porque son muy grandes (los generé pero no los subí al repo remoto para garantizar la manejabilidad). Recomiendo usar los archivos por familias del directorio `salidas_RDS`, y si se necesitase un `.kml` de registros de presencia depurados, generarlo al momento con el siguiente código (ejemplo para Acanthaceae):

```{r, eval=F}
library(sf)
acanthaceae <- readRDS('salidas_RDS/todos_los_objetos_Acanthaceae.RDS')
st_write(
      obj = acanthaceae$reg_pres_sf %>% select(-networkKeys),
      dsn = 'salidas_sf/reg_hex_inter_Acanthaceae.kml',
      delete_dsn = T)
```

A continuación se incluyen algunos resúmenes básicos de todas las familias.

- Número de registros limpios por familia.

```{r}
registros_desde_rds <- sapply(
  X = fam_sel,
  function(x) {
    readRDS(paste0('salidas_RDS/reg_hex_inter_', x, '.RDS'))
  })
as.data.frame(sapply(registros_desde_rds, nrow)) %>% 
  rownames_to_column('Familia') %>% 
  rename(`Número de registros de presencia en GBIF (limpios)` = names(.)[2]) %>% 
  kable()
```

- Riqueza de especies por familia.

```{r}
mc_desde_rds <- sapply(
  X = fam_sel,
  function(x) {
    readRDS(paste0('salidas_mc/mc_nombres_largos_', x, '.RDS'))
  })
as.data.frame(sapply(mc_desde_rds, function(x) specnumber(colSums(x)))) %>% 
  rownames_to_column('Familia') %>% 
  rename(`Riqueza de especies` = names(.)[2]) %>% 
  kable()
```

# Referencias